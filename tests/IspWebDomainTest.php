<?php

namespace App\Tests;

use IspManagerApi\IspWebDomain\IspWebDomain;
use IspManagerApi\IspWebDomain\IspWebDomainDto;

class IspWebDomainTest extends IspAbstractTest
{
    public function testList(): void
    {
        $callResult = '{"doc":{"$lang":"en","$func":"webdomain","$binary":"/ispmgr","$host":"https://fake-site.com:1500","$themename":"dragon","$features":"ed13fed30f9503fcf2cdf0415231f846","$notify":"","$favorite":"no","$pin":"no","$theme":"/manimg/dragon/","$css":"main.css","$logo":"logo.png","$logolink":"https://fake-site.com","$favicon":"favicon.ico","$localdir":"local_bcb81b722638/","elem":[{"active":{"$":"on"},"analyzer":{"$":"off"},"database":{"$orig":"db_not_assigned","$":"Notused"},"docroot":{"$":"/var/www/user0/data/www/testsite.ru"},"handler":{"$":"PHPFastCGI(Nginx+PHP-FPM)8.2.6(alt)"},"id":{"$":"1"},"ipaddr":{"$":"192.168.0.1"},"name":{"$":"testsite.ru"},"owner":{"$":"user0"},"php":{"$":"PathtoPHP:/opt/php82/bin/php."},"php_mode":{"$":"php_mode_fcgi_nginxfpm"},"php_version":{"$":"8.2.6(alt)"},"secure":{"$":"on"},"ssl_issued_success":{},"webscript_status":{}}],"messages":{"$name":"webdomain","$checked":"ed13fed30f9503fcf2cdf0415231f846","msg":{"hint_add_to_favorite":"Addtofavoritepaths","hint_remove_from_favorite":"Removefromfavoritepaths"}},"metadata":{"$name":"webdomain","$type":"list","$key":"name","$mgr":"ispmgr","coldata":{"col":[{"$type":"data","$name":"name","$sort":"alpha","$convert":"punycode","$sorted":"+1"},{"$type":"prop","$name":"ssl","$sort":"prop","prop":[{"$name":"ssl_issued_success","$img":"p-tick-green","$spritesvg":"yes"},{"$name":"ssl_issued_error","$img":"p-fail","$spritesvg":"yes"},{"$name":"ssl_not_used","$img":"p-no-grey","$spritesvg":"yes"}],"xprop":[{"$name":"ssl_le_processing","$func":"webdomain.letsencrypt.log","$type":"editlist","$img":"p-processing-blue","$spritesvg":"yes"},{"$name":"ssl_status","$value":"le_processing_has_error","$func":"webdomain.letsencrypt.log","$type":"editlist","$img":"p-danger-red","$spritesvg":"yes"},{"$name":"ssl_status","$value":"le_issued_error","$func":"webdomain.letsencrypt.log","$type":"editlist","$img":"p-fail","$spritesvg":"yes"}]},{"$type":"data","$name":"owner","$sort":"alpha","$level":"reseller+"},{"$type":"data","$name":"docroot","$sort":"alpha"},{"$type":"data","$name":"ipaddr","$sort":"alpha"},{"$type":"prop","$name":"prop","$sort":"prop","prop":[{"$name":"php","$img":"p-php","$stat":"yes","$sprite":"yes","$spritesvg":"yes","$total":"4"},{"$name":"cgi","$img":"p-cgi","$stat":"yes","$sprite":"yes","$spritesvg":"yes","$total":"0"},{"$name":"foreground","$img":"p-lt3","$sprite":"yes","$spritesvg":"yes"},{"$name":"datapass_to","$img":"p-procin","$animated":"yes","$type":"list","$spritesvg":"yes"}],"xprop":[{"$name":"webscript_status","$value":"installing","$animated":"yes","$img":"p-install","$spritesvg":"yes"},{"$name":"nodejs_status_0","$img":"p-nodejs-install","$animated":"yes","$spritesvg":"yes"},{"$name":"nodejs_status_1","$img":"p-nodejs-good","$spritesvg":"yes"},{"$name":"nodejs_status_2","$img":"p-nodejs-bad","$spritesvg":"yes"},{"$name":"nodejs_status_3","$img":"p-nodejs-install","$animated":"yes","$spritesvg":"yes"},{"$name":"nodejs_status_4","$img":"p-nodejs-install","$animated":"yes","$spritesvg":"yes"},{"$name":"nodejs_status_5","$img":"p-nodejs-install","$animated":"yes","$spritesvg":"yes"},{"$name":"nodejs_status_6","$img":"p-nodejs-install","$animated":"yes","$spritesvg":"yes"},{"$name":"nodejs_status_7","$img":"p-nodejs-good","$spritesvg":"yes"},{"$name":"python_status_0","$img":"p-python-install","$spritesvg":"yes"},{"$name":"python_status_1","$img":"p-python-good","$spritesvg":"yes"},{"$name":"python_status_2","$img":"p-python-bad","$spritesvg":"yes"},{"$name":"python_status_3","$img":"p-python-install","$spritesvg":"yes"},{"$name":"python_status_5","$img":"p-python-install","$spritesvg":"yes"},{"$name":"python_status_6","$img":"p-python-install","$spritesvg":"yes"},{"$name":"python_status_7","$img":"p-python-good","$spritesvg":"yes"},{"$name":"python_status_8","$img":"p-python-install","$spritesvg":"yes"},{"$name":"python_status_9","$img":"p-python-good","$spritesvg":"yes"},{"$name":"phpcomposer_status","$value":"installing","$animated":"yes","$img":"p-install","$spritesvg":"yes"},{"$name":"phpcomposer_status","$value":"setup_error","$img":"p-lt4","$sprite":"yes","$spritesvg":"yes"},{"$name":"phpcomposer_status","$value":"error","$img":"p-lt4","$sprite":"yes","$spritesvg":"yes"}]},{"$type":"msg","$name":"database","$sort":"alpha"},{"$type":"data","$name":"handler","$sort":"alpha"},{"$type":"toggle","$name":"active","$sort":"toggle","toggle":{"$name":"active","$onenable":"webdomain.resume","$ondisable":"webdomain.suspend"}}]},"contextmenu":{"toolgrp":[{"$name":"go","toolbtn":[{"$name":"go","$func":"webdomain.go","$type":"window","$img":"t-insert","$sprite":"yes","$spritesvg":"yes"},{"$name":"go_db","$func":"site.db.redirect","$type":"window","$img":"t-insert","$sprite":"yes","$spritesvg":"yes","hide":[{"$name":"database","$value":"Notused"}]}]},{"$name":"edit","toolbtn":[{"$name":"edit","$func":"site.edit","$type":"edit","$img":"t-edit","$default":"yes","$sprite":"yes","$spritesvg":"yes"},{"$name":"php","$func":"phpconf","$type":"editlist","$img":"t-editlist","$sprite":"yes","$spritesvg":"yes","show":[{"$name":"php_mode","$value":"php_mode_fcgi_nginxfpm"},{"$name":"cgi_site_settings","$value":"on"},{"$name":"php_mode","$value":"php_mode_mod"}]},{"$name":"plain","$func":"webdomain.plain","$type":"edit","$img":"t-editlist","$level":"adminsuper","$sprite":"yes","$spritesvg":"yes"}]},{"$name":"error","toolbtn":[{"$name":"error","$func":"webdomain.error","$type":"editlist","$img":"t-errpage","$sprite":"yes","$spritesvg":"yes"},{"$name":"redirect","$func":"webdomain.redirect","$type":"editlist","$img":"t-redirect","$sprite":"yes","$spritesvg":"yes"},{"$name":"diraccess","$func":"webdomain.diraccess","$type":"editlist","$img":"t-lock","$sprite":"yes","$spritesvg":"yes"},{"$name":"journal","$func":"webdomain.journal","$type":"editlist","$img":"t-rotate","$sprite":"yes","$spritesvg":"yes"},{"$name":"stat","$func":"webdomain.stat","$type":"window","$img":"t-stat","$sprite":"yes","$spritesvg":"yes","hide":[{"$name":"analyzer","$value":"off"}]}]},{"$name":"context_phpcomposer"},{"$name":"context_restart"},{"$name":"context_python"},{"$name":"context_resume","toolbtn":[{"$name":"context_resume","$func":"webdomain.resume","$type":"group","$img":"t-on","$sprite":"yes","$spritesvg":"yes","show":[{"$name":"active","$value":"off"}]},{"$name":"context_suspend","$func":"webdomain.suspend","$type":"group","$img":"t-off","$sprite":"yes","$spritesvg":"yes","show":[{"$name":"active","$value":"on"}]},{"$name":"delete","$func":"webdomain.delete.confirm","$type":"groupform","$img":"t-delete","$sprite":"yes","$spritesvg":"yes"}]},{"$name":"happyfilter","toolbtn":[{"$name":"happyfilter","$func":"webdomain.happyfilter","$img":"t-filterhappy","$type":"editlist","$level":"reseller+","$sprite":"yes","$spritesvg":"yes"},{"$name":"context_su","$func":"webdomain.su","$type":"editlist","$img":"t-go","$sprite":"yes","$spritesvg":"yes"}]}]},"toolbar":{"toolgrp":[{"$name":"new_site","toolbtn":[{"$name":"new_site","$func":"site.edit","$type":"new","$img":"t-new","$detached":"yes","$sprite":"yes","$spritesvg":"yes"}]},{"$name":"management","$img":"t-edit","$collapsed":"yes","$sprite":"yes","$spritesvg":"yes","toolbtn":[{"$name":"edit","$func":"site.edit","$type":"edit","$img":"t-edit","$default":"yes","$sprite":"yes","$spritesvg":"yes"},{"$name":"delete","$func":"webdomain.delete.confirm","$type":"groupform","$img":"t-delete","$sprite":"yes","$spritesvg":"yes"}]},{"$name":"php","toolbtn":[{"$name":"php","$func":"phpconf","$type":"editlist","$img":"t-set","$sprite":"yes","$spritesvg":"yes","show":[{"$name":"php_mode","$value":"php_mode_fcgi_nginxfpm"},{"$name":"cgi_site_settings","$value":"on"},{"$name":"php_mode","$value":"php_mode_mod"}]},{"$name":"plain","$func":"webdomain.plain","$type":"edit","$img":"t-default","$level":"adminsuper","$sprite":"yes","$spritesvg":"yes"},{"$name":"file","$func":"webdomain.file","$type":"editlist","$img":"t-folder","$level":"usersuper","$sprite":"yes","$spritesvg":"yes"},{"$name":"resume","$func":"webdomain.resume","$type":"group","$img":"t-on","$sprite":"yes","$spritesvg":"yes","show":[{"$name":"active","$value":"off"}]},{"$name":"suspend","$func":"webdomain.suspend","$type":"group","$img":"t-off","$sprite":"yes","$spritesvg":"yes","show":[{"$name":"active","$value":"on"}]},{"$name":"apps","$func":"aps.user_catalog","$type":"editlist","$img":"t-autocredit","$sprite":"yes","$spritesvg":"yes","hide":[{"$name":"nodejs","$value":"on"},{"$name":"python","$value":"on"}]}]},{"$name":"plugins","$img":"t-plugins","$sprite":"yes","$spritesvg":"yes","toolbtn":[{"$func":"sitepro.open","$type":"window","$img":"t-sitepro","$name":"sitepro_button","$default":"yes","hide":[{"$name":"nodejs","$value":"on"}]}]},{"$name":"su","toolbtn":[{"$name":"su","$func":"webdomain.su","$type":"editlist","$img":"t-go","$sprite":"yes","$spritesvg":"yes"},{"$name":"filter","$func":"webdomain.filter","$type":"new","$img":"t-filter","$sprite":"yes","$spritesvg":"yes"}]},{"$name":"outside_sep","$separator":"yes"},{"$name":"outside","$img":"t-plugins","$sprite":"yes","$spritesvg":"yes"}]}},"p_cnt":{"$":"1000"},"p_elems":{"$":"5"},"p_num":{"$":"1"},"p_order":{"$":"asc"},"p_possible_filters":{"filter":[{"$name":"name"},{"$name":"alias"},{"$name":"owner"},{"$name":"ipaddr"},{"$name":"active"},{"$name":"site_handler"},{"$name":"php_version"},{"$name":"nodejs_version"},{"$name":"python_version"}]},"p_sort":{"$":"name"},"page":[{"$":"fake-site.com-test.ru"}],"saved_filters":{},"tips":{"tip":{"$":"mbar_pin"}},"tparams":{"func":{"$":"webdomain"},"out":{"$":"sjson"}}}}';
        $function = new IspWebDomain($this->mockConnection($callResult));
        $function->setAccessData($this->getAccessDto());

        $expected = [new IspWebDomainDto(
            1,
            'testsite.ru',
            true,
            '192.168.0.1',
            null,
            '/var/www/user0/data/www/testsite.ru',
            'PHPFastCGI(Nginx+PHP-FPM)8.2.6(alt)',
            'user0',
            'php_mode_fcgi_nginxfpm',
            'PathtoPHP:/opt/php82/bin/php.',
            '8.2.6(alt)',
            true
        )];

        $result = $function->list();

        $this->assertJsonStringEqualsJsonString(json_encode($expected), json_encode($result));    // No exception
    }
}
